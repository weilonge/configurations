#!/bin/bash
# Note 1: Add this line `source ~/configurations/bash_source_me` in
# ~/.bash_profile (for MacOSX) or ~/.bashrc (for Linux)
#
# Note 2: Since MacOSX and Linux use ~/.bashrc and ~/.bash_profile in different
# ways, add the following lines to ~/.bash_profile to make sure ~/.bashrc is
# loaded correctly.
# ```
# if [ -f ~/.bashrc ]; then
#     source ~/.bashrc
# fi
# ```

platform='unknown'
unamestr=`uname`
if [[ "$unamestr" == 'Linux' ]]; then
    platform='Linux'
elif [[ "$unamestr" == 'Darwin' ]]; then
    platform='Darwin'
fi

# START: default language
if [[ $platform == 'Linux' ]]; then
    export LC_ALL="en_US.UTF-8"
    export LC_CTYPE="en_US.UTF-8"
fi
# END: default language

# START: git-completion
# Use homebrew's git completion script here or the script in configurations.git:
if [[ $platform == 'Darwin' ]]; then
# GIT_COMPLETION_BASH=~/configurations/git/git-completion.bash
  GIT_COMPLETION_BASH=$(brew --prefix)/etc/bash_completion.d/git-completion.bash
  if [ -f ${GIT_COMPLETION_BASH} ]; then
    . ${GIT_COMPLETION_BASH}
  fi
fi
# END: git-completion

# START: powerline-shell
function _update_ps1() {
    PS1="$(powerline-shell $?)"
}
if [ -x "`which powerline-shell`" ] && [ "$TERM" != "linux" ]; then
    PROMPT_COMMAND="_update_ps1; $PROMPT_COMMAND"
fi
# END: powerline-shell

# START: CUDA
if [[ $platform == 'Linux' ]]; then
    export CUDA_HOME=/usr/local/cuda
    export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:${CUDA_HOME}/lib64:${CUDA_HOME}/extras/CUPTI/lib64"
    export PATH="$CUDA_HOME/bin:$PATH"
elif [[ $platform == 'Darwin' ]]; then
    export CUDA_HOME=/usr/local/cuda
    export DYLD_LIBRARY_PATH="$DYLD_LIBRARY_PATH:$CUDA_HOME/lib"
    export PATH="$CUDA_HOME/bin:$PATH"
fi
# END: CUDA

# START: rust
# rust package management
if [ -f ~/.cargo/env ]; then
    source ~/.cargo/env
fi
# END: rust

# START: helper
stack() {
  op=$1
  name=$2
  value=$3
  file=/tmp/bash_stack_$name.$$

  case $op in
  push)
    echo $value >> $file
    ;;
  pop)
    if [ -f $file ]; then
      tail -1 $file
      sed -i DME -e '$d' $file
      rm ${file}DME
    fi
    ;;
  esac
}
mygrepall() { grep -rn ./ -e $1;}
# END: helper

# START: td
# Use `td` to show a notification in OS. It can be used with `;` to combine it
# with other commands, e.g. `git remote update; td`
# Use `tdbg` to show a notification after the background job applied. It can
# be used with `[ctrl-z]` to put the job in the background and show a
# notification after it's finished.
alias td="tnot \$?"
tdbg() {
  OUTPUT=`jobs -l | grep '^\[[0-9]*\]+' | sed -n 's/^\[\([0-9]*\)\]+/\1/p'`
  JOB_ID=`echo ${OUTPUT} | awk '{print $1}'`
  PID=`echo ${OUTPUT} | awk '{print $2}'`

  fg $JOB_ID
  wait $PID
  td
}
# END: td

alias kDS_Store="find . -name \'*.DS_Store\' -type f -delete"
alias kDot_="find . -name \'._*\' -type f -delete"
alias kUdFuse="kill `ps aux | grep udFuse | grep -v grep | awk '{print $2}'`"
alias mydu="du -sch .[!.]* * |sort -h"
alias yd="ydict.js"
# Force tmux to assume the terminal supports 256 colours.
if [[ $platform == 'Linux' ]]; then
    alias tmux="tmux -2"
fi
# alias du_cc='du -sh'
# alias du_sf='du -d1 -h'
if [[ $platform == 'Linux' ]]; then
  alias pbcopy="xclip -selection clipboard"
  alias pbpaste="xclip -selection clipboard -o"
fi
# END: helper

# START: synergy
if [[ $platform == 'Linux' ]]; then
  alias synergy-stop="systemctl stop synergy"
  alias synergy-start="systemctl start synergy"
elif [[ $platform == 'Darwin' ]]; then
  alias synergy-stop="launchctl unload /Library/LaunchAgents/com.symless.synergy.synergy-service.plist"
  alias synergy-start="launchctl load /Library/LaunchAgents/com.symless.synergy.synergy-service.plist"
fi
# END: synergy

# START: rtfm
# Reference:
# https://www.commandlinefu.com/commands/view/7581/rtfm-function
rtfm() { help $@ || man $@ || open "http://www.google.com/search?q=$@"; }
# END: rtfm

# START: weather
# Reference:
# https://www.commandlinefu.com/commands/view/17709/nice-weather-forecast-on-your-shell
weather() { curl -s wttr.in/$1; }
# END: weather

# START: showWhosUsingNet
# Reference:
# https://www.commandlinefu.com/commands/view/3542/show-apps-that-use-internet-connection-at-the-moment.-multi-language
showWhosUsingNet() { lsof -P -i -n; }
# END: showWhosUsingNet

dict() { ydict.js $1 | less -R; }

# START: ytmp3
# Reference:
# https://www.commandlinefu.com/commands/view/9701/convert-youtube-videos-to-mp3
ytmp3() { youtube-dl -t --extract-audio --audio-format mp3 $@; }
# END: ytmp3

# START: esp-idf
PATH=$PATH:$HOME/Projects/esp32_esp-idf/xtensa-esp32-elf/bin
export IDF_PATH=~/Projects/esp32_esp-idf/esp-idf
# END: esp-idf

# START: path
PATH=~/configurations/bin\
:~/bin\
:$PATH

if [[ $platform == 'Darwin' ]]; then
  PATH=/usr/local/sbin:$PATH
fi
# END: path
